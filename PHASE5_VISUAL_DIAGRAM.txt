# 🎨 Sistema de Autenticación Biométrica - Diagrama Visual

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│                   GOVELING - TRAVEL DOCUMENTS                               │
│                   Sistema de Autenticación Multi-Nivel                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
                          FLUJO PRINCIPAL DE AUTENTICACIÓN
═══════════════════════════════════════════════════════════════════════════════


    Usuario abre                                                              
    Travel Documents                                                          
         │                                                                    
         ↓                                                                    
    ┌─────────────────┐                                                       
    │ ¿Tiene PIN?     │                                                       
    └────────┬────────┘                                                       
             │                                                                
      ┌──────┴──────┐                                                         
      │             │                                                         
     NO            SÍ                                                          
      │             │                                                         
      ↓             ↓                                                         
┌─────────────┐  ┌─────────────────────┐                                     
│ PIN Setup   │  │ ¿Biometría enabled? │                                     
│ Modal       │  └──────────┬──────────┘                                     
└──────┬──────┘             │                                                 
       │             ┌──────┴──────┐                                          
       │            NO             SÍ                                          
       │             │              │                                         
       │             ↓              ↓                                         
       │    ┌──────────────┐  ┌──────────────────┐                           
       │    │ PIN Input    │  │ Auto-trigger     │                           
       │    │ (Tradicional)│  │ Biometría (300ms)│                           
       │    └──────────────┘  └────────┬─────────┘                           
       │                               │                                      
       └────────┬──────────────────────┼──────┐                              
                │                      │      │                              
                ↓                  Éxito    Fallo                             
        ┌────────────────┐           │      │                                
        │ Acceso a       │←──────────┘      ↓                                
        │ Documentos     │            ┌──────────────┐                        
        └────────────────┘            │ Fallback a   │                        
                                      │ PIN Manual   │                        
                                      └──────┬───────┘                        
                                             │                                
                                             ↓                                
                                      ┌──────────────┐                        
                                      │ Botón Face ID│                        
                                      │      o       │                        
                                      │  PIN Input   │                        
                                      └──────┬───────┘                        
                                             │                                
                                             ↓                                
                                      Acceso concedido


═══════════════════════════════════════════════════════════════════════════════
                          ARCHITECTURE OVERVIEW
═══════════════════════════════════════════════════════════════════════════════


┌─────────────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER (React Native)                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────┐     │
│  │ TravelDocumentsModal.tsx                                          │     │
│  │                                                                   │     │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐      │     │
│  │  │ Header      │  │ Documents   │  │ Add Document        │      │     │
│  │  │ [⚙️][+][❌] │  │ List        │  │ Button              │      │     │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘      │     │
│  │                                                                   │     │
│  │  Children Modals:                                                 │     │
│  │  ┌─────────────────────┐  ┌─────────────────────┐               │     │
│  │  │ SecuritySettings    │  │ PinVerification     │               │     │
│  │  │ Modal               │  │ Modal               │               │     │
│  │  │                     │  │                     │               │     │
│  │  │ • Toggle biometric  │  │ • Auto-trigger      │               │     │
│  │  │ • Info boxes        │  │ • Manual button     │               │     │
│  │  │ • Warnings          │  │ • PIN fallback      │               │     │
│  │  └─────────────────────┘  └─────────────────────┘               │     │
│  └───────────────────────────────────────────────────────────────────┘     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                     ↕
┌─────────────────────────────────────────────────────────────────────────────┐
│                         BUSINESS LOGIC LAYER (Services)                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────┐     │
│  │ biometricAuth.ts                                                  │     │
│  │                                                                   │     │
│  │  📦 Exported Functions:                                           │     │
│  │                                                                   │     │
│  │  ✓ checkBiometricCapabilities() → BiometricCapabilities          │     │
│  │  ✓ authenticateWithBiometrics(msg) → AuthResult                  │     │
│  │  ✓ isBiometricAuthEnabled() → boolean                            │     │
│  │  ✓ setBiometricAuthEnabled(bool) → void                          │     │
│  │  ✓ getBiometricTypeName(type) → string                           │     │
│  │  ✓ getBiometricIconName(type) → string                           │     │
│  │  ✓ promptEnableBiometrics() → boolean                            │     │
│  │  ✓ disableBiometricAuth() → void                                 │     │
│  │                                                                   │     │
│  └───────────────────────────────────────────────────────────────────┘     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                     ↕
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DATA LAYER (Storage & OS)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌────────────────────────┐         ┌────────────────────────┐             │
│  │ AsyncStorage           │         │ OS Biometric APIs      │             │
│  │                        │         │                        │             │
│  │ • biometric_auth       │         │ • Secure Enclave (iOS) │             │
│  │   _enabled: boolean    │         │ • TEE (Android)        │             │
│  │                        │         │                        │             │
│  │ • travel_documents_pin │         │ • Face ID              │             │
│  │   : string (hash)      │         │ • Touch ID             │             │
│  │                        │         │ • Fingerprint          │             │
│  └────────────────────────┘         │ • Iris Scanner         │             │
│                                     └────────────────────────┘             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
                      SECURITY SETTINGS MODAL - UI STATES
═══════════════════════════════════════════════════════════════════════════════


┌─────────────────────────────────────────────────────────────────────────────┐
│ STATE 1: Biométrica Disponible y Habilitada                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    ← Seguridad                                                              │
│                                                                             │
│    ┌─────────────────────────────────────────────────────────────┐         │
│    │ 🎭                                                           │         │
│    │ Face ID                         ⚪━━━━━━━━━●  ON            │         │
│    │ Acceso rápido a tus documentos                               │         │
│    └─────────────────────────────────────────────────────────────┘         │
│                                                                             │
│    ┌─────────────────────────────────────────────────────────────┐         │
│    │ ℹ️ Podrás usar Face ID en lugar de tu PIN para acceder      │         │
│    │    a tus documentos. Si Face ID falla, siempre podrás       │         │
│    │    usar tu PIN como alternativa.                             │         │
│    └─────────────────────────────────────────────────────────────┘         │
│                                                                             │
│    ──────────────────────────────────────────────────────────────          │
│                                                                             │
│    ┌─────────────────────────────────────────────────────────────┐         │
│    │ 🔑 Cambiar PIN                                          →    │         │
│    │ Establece un nuevo PIN de acceso                             │         │
│    └─────────────────────────────────────────────────────────────┘         │
│                                                                             │
│    ──────────────────────────────────────────────────────────────          │
│                                                                             │
│    🛡️ Información de Seguridad                                             │
│                                                                             │
│    Tus documentos están protegidos con encriptación AES-256-GCM,           │
│    el mismo estándar usado por bancos y gobiernos. Tu PIN y datos          │
│    biométricos nunca abandonan tu dispositivo.                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│ STATE 2: Biométrica Disponible pero Deshabilitada                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    ← Seguridad                                                              │
│                                                                             │
│    ┌─────────────────────────────────────────────────────────────┐         │
│    │ 🎭                                                           │         │
│    │ Face ID                         ●━━━━━━━━━⚪  OFF           │         │
│    │ Acceso rápido a tus documentos                               │         │
│    └─────────────────────────────────────────────────────────────┘         │
│                                                                             │
│    (No info box)                                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│ STATE 3: Hardware pero No Configurado                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    ← Seguridad                                                              │
│                                                                             │
│    ┌─────────────────────────────────────────────────────────────┐         │
│    │ 🎭                                                           │         │
│    │ Face ID                         ●━━━━━━━━━⚪  OFF           │         │
│    │ Configura primero en Ajustes del dispositivo                 │         │
│    └─────────────────────────────────────────────────────────────┘         │
│                                                                             │
│    ┌─────────────────────────────────────────────────────────────┐         │
│    │ ⚠️ Ve a Ajustes del dispositivo y configura Face ID para    │         │
│    │    usar esta función.                                        │         │
│    └─────────────────────────────────────────────────────────────┘         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│ STATE 4: No Disponible (Sin Hardware)                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    ← Seguridad                                                              │
│                                                                             │
│    ┌─────────────────────────────────────────────────────────────┐         │
│    │ 🔒                                                           │         │
│    │ Autenticación Biométrica        ●━━━━━━━━━⚪  OFF           │         │
│    │ No disponible en este dispositivo                            │         │
│    └─────────────────────────────────────────────────────────────┘         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
                  PIN VERIFICATION MODAL - UI STATES
═══════════════════════════════════════════════════════════════════════════════


┌─────────────────────────────────────────────────────────────────────────────┐
│ STATE 1: Con Biometría Habilitada (Después de cancelar auto-trigger)       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                            🔒                                               │
│                                                                             │
│              Ingresa tu PIN para continuar                                  │
│                                                                             │
│    ┌───────────────────────────────────────────────────────────┐           │
│    │  🎭  Usar Face ID                                         │           │
│    └───────────────────────────────────────────────────────────┘           │
│                                                                             │
│                  ──────────  o  ──────────                                  │
│                                                                             │
│                    [ ]  [ ]  [ ]  [ ]                                       │
│                                                                             │
│               ┌────────────────────────┐                                    │
│               │  Verificar PIN         │                                    │
│               └────────────────────────┘                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│ STATE 2: Solo PIN (Biometría Deshabilitada)                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                            🔒                                               │
│                                                                             │
│              Ingresa tu PIN para continuar                                  │
│                                                                             │
│                    [ ]  [ ]  [ ]  [ ]                                       │
│                                                                             │
│               ┌────────────────────────┐                                    │
│               │  Verificar PIN         │                                    │
│               └────────────────────────┘                                    │
│                                                                             │
│                  ¿Olvidaste tu PIN?                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
                          INTERACTION TIMELINE
═══════════════════════════════════════════════════════════════════════════════


TIME: 0ms
┌─────────────────────────────────────────────────────────────────────────────┐
│ Usuario hace tap en "Travel Documents"                                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                ↓

TIME: 50ms
┌─────────────────────────────────────────────────────────────────────────────┐
│ PinVerificationModal se abre con animación slide                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                ↓

TIME: 100ms
┌─────────────────────────────────────────────────────────────────────────────┐
│ useEffect detecta: visible=true && !biometricAttempted                      │
│ Llama a checkAndTriggerBiometric()                                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                ↓

TIME: 150ms
┌─────────────────────────────────────────────────────────────────────────────┐
│ checkBiometricCapabilities() → Returns: isAvailable=true, type=faceId      │
│ isBiometricAuthEnabled() → Returns: true                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                ↓

TIME: 300ms
┌─────────────────────────────────────────────────────────────────────────────┐
│ setTimeout completa, llama handleBiometricAuth()                            │
└─────────────────────────────────────────────────────────────────────────────┘
                                ↓

TIME: 350ms
┌─────────────────────────────────────────────────────────────────────────────┐
│ Sistema iOS/Android muestra prompt nativo de Face ID/Touch ID              │
│                                                                             │
│    ┌─────────────────────────────────┐                                     │
│    │         👤                      │                                     │
│    │   Coloca tu rostro frente      │                                     │
│    │   a la cámara para              │                                     │
│    │   desbloquear                   │                                     │
│    │                                 │                                     │
│    │       [Cancelar]                │                                     │
│    └─────────────────────────────────┘                                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                ↓

TIME: 1500ms (Usuario autentica)
┌─────────────────────────────────────────────────────────────────────────────┐
│ authenticateWithBiometrics() → Returns: { success: true, biometricType }   │
└─────────────────────────────────────────────────────────────────────────────┘
                                ↓

TIME: 1550ms
┌─────────────────────────────────────────────────────────────────────────────┐
│ handleClose() → Cierra PinVerificationModal                                 │
│ onSuccess() → Ejecuta callback, permite acceso a documentos                │
└─────────────────────────────────────────────────────────────────────────────┘
                                ↓

TIME: 1650ms
┌─────────────────────────────────────────────────────────────────────────────┐
│ Usuario ve lista de documentos de viaje                                    │
│ ✅ Autenticación completada en ~1.6 segundos                                │
└─────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
                       DATA FLOW DIAGRAM
═══════════════════════════════════════════════════════════════════════════════


  ┌─────────────────┐
  │ User Action     │
  │ Tap "Travel     │
  │ Documents"      │
  └────────┬────────┘
           │
           ↓
  ┌─────────────────────┐
  │ TravelDocuments     │
  │ Modal               │────┐
  │                     │    │ Reads
  │ • checkPinStatus()  │←───┤ hasPinConfigured()
  └────────┬────────────┘    │ from AsyncStorage
           │                 │
           ↓                 │
  ┌─────────────────────┐    │
  │ Has PIN?            │    │
  └────────┬────────────┘    │
           │                 │
         YES                 │
           │                 │
           ↓                 │
  ┌─────────────────────┐    │
  │ PinVerification     │    │
  │ Modal               │    │
  │                     │    │
  │ useEffect()         │────┤
  │   ↓                 │    │ Reads
  │ checkAndTrigger     │    │ biometric_auth_enabled
  │ Biometric()         │←───┤ from AsyncStorage
  │   ↓                 │    │
  │ isBiometricEnabled? │    │
  └────────┬────────────┘    │
           │                 │
         YES                 │
           │                 │
           ↓                 │
  ┌─────────────────────┐    │
  │ biometricAuth.ts    │    │
  │                     │    │
  │ authenticate        │    │
  │ WithBiometrics()    │    │
  │   ↓                 │    │
  │ Calls expo-local-   │    │
  │ authentication      │    │
  └────────┬────────────┘    │
           │                 │
           ↓                 │
  ┌─────────────────────┐    │
  │ iOS/Android OS      │    │
  │                     │    │
  │ Secure Enclave      │    │
  │ or TEE              │    │
  │                     │    │
  │ Face ID / Touch ID  │    │
  │ / Fingerprint       │    │
  └────────┬────────────┘    │
           │                 │
       Success               │
           │                 │
           ↓                 │
  ┌─────────────────────┐    │
  │ onSuccess()         │    │
  │ callback            │    │
  │   ↓                 │    │
  │ Access granted to   │    │
  │ Travel Documents    │    │
  └─────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
                   COMPONENT RELATIONSHIPS
═══════════════════════════════════════════════════════════════════════════════


                      ┌──────────────────────────────┐
                      │                              │
                      │  TravelDocumentsModal.tsx    │
                      │  (Parent Container)          │
                      │                              │
                      └──────────┬───────────────────┘
                                 │
                ┌────────────────┼────────────────┐
                │                │                │
                ↓                ↓                ↓
    ┌─────────────────┐  ┌────────────────┐  ┌──────────────────┐
    │ SecuritySettings│  │ PinVerification│  │ DocumentViewer   │
    │ Modal           │  │ Modal          │  │ Modal            │
    │                 │  │                │  │                  │
    │ • Toggle        │  │ • Auto-trigger │  │ • View document  │
    │ • Info boxes    │  │ • Manual btn   │  │ • Open PDF       │
    │ • Warnings      │  │ • PIN fallback │  │ • Delete         │
    └─────────┬───────┘  └────────┬───────┘  └──────────────────┘
              │                   │
              │                   │
              └──────────┬────────┘
                         │
                         ↓
              ┌──────────────────────┐
              │                      │
              │  biometricAuth.ts    │
              │  (Service Layer)     │
              │                      │
              │  • Check capabilities│
              │  • Authenticate      │
              │  • Store prefs       │
              │  • Get type/icon     │
              └──────────┬───────────┘
                         │
              ┌──────────┴──────────┐
              │                     │
              ↓                     ↓
    ┌──────────────────┐  ┌──────────────────┐
    │ AsyncStorage     │  │ expo-local-      │
    │                  │  │ authentication   │
    │ • Preferences    │  │                  │
    │ • PIN hash       │  │ • OS integration │
    └──────────────────┘  └──────────────────┘


═══════════════════════════════════════════════════════════════════════════════
                         FEATURE MATRIX
═══════════════════════════════════════════════════════════════════════════════


┌─────────────────────────┬──────────┬──────────┬──────────┬──────────┐
│ Feature                 │   iOS    │ Android  │ Simulator│  Status  │
├─────────────────────────┼──────────┼──────────┼──────────┼──────────┤
│ Face ID                 │    ✅    │    ❌    │    ⚠️    │    ✅    │
├─────────────────────────┼──────────┼──────────┼──────────┼──────────┤
│ Touch ID                │    ✅    │    ❌    │    ⚠️    │    ✅    │
├─────────────────────────┼──────────┼──────────┼──────────┼──────────┤
│ Fingerprint             │    ❌    │    ✅    │    ⚠️    │    ✅    │
├─────────────────────────┼──────────┼──────────┼──────────┼──────────┤
│ Iris Scanner            │    ❌    │    ⚠️    │    ❌    │    ✅    │
├─────────────────────────┼──────────┼──────────┼──────────┼──────────┤
│ Auto-trigger            │    ✅    │    ✅    │    ✅    │    ✅    │
├─────────────────────────┼──────────┼──────────┼──────────┼──────────┤
│ Manual button           │    ✅    │    ✅    │    ✅    │    ✅    │
├─────────────────────────┼──────────┼──────────┼──────────┼──────────┤
│ PIN fallback            │    ✅    │    ✅    │    ✅    │    ✅    │
├─────────────────────────┼──────────┼──────────┼──────────┼──────────┤
│ Settings toggle         │    ✅    │    ✅    │    ✅    │    ✅    │
├─────────────────────────┼──────────┼──────────┼──────────┼──────────┤
│ Preference persistence  │    ✅    │    ✅    │    ✅    │    ✅    │
├─────────────────────────┼──────────┼──────────┼──────────┼──────────┤
│ Dynamic icons           │    ✅    │    ✅    │    ✅    │    ✅    │
├─────────────────────────┼──────────┼──────────┼──────────┼──────────┤
│ Info boxes              │    ✅    │    ✅    │    ✅    │    ✅    │
├─────────────────────────┼──────────┼──────────┼──────────┼──────────┤
│ Warning boxes           │    ✅    │    ✅    │    ✅    │    ✅    │
├─────────────────────────┼──────────┼──────────┼──────────┼──────────┤
│ Error handling          │    ✅    │    ✅    │    ✅    │    ✅    │
└─────────────────────────┴──────────┴──────────┴──────────┴──────────┘

Legend:
✅ = Fully Supported
⚠️ = Limited Support (Simulator can only test UI, not actual biometrics)
❌ = Not Supported


═══════════════════════════════════════════════════════════════════════════════
                         PROJECT STATUS
═══════════════════════════════════════════════════════════════════════════════


┌───────────────────────────────────────────────────────────────────────────┐
│                                                                           │
│  ✅ Fase 1: Database & Backend (100%)                                     │
│     • Supabase tables, RLS, edge functions                                │
│                                                                           │
│  ✅ Fase 2: Frontend Foundation (100%)                                    │
│     • Modal structure, empty states                                       │
│                                                                           │
│  ✅ Fase 3: Sistema de PIN (100%)                                         │
│     • PIN setup, verification, encryption                                 │
│                                                                           │
│  ✅ Fase 4.1: Formulario de Documentos (100%)                             │
│     • Input fields, validation, image picker                              │
│                                                                           │
│  ✅ Fase 4.2: Encriptación y Subida (100%)                                │
│     • Edge function integration, storage                                  │
│                                                                           │
│  ✅ Fase 4.3: Visualización de Documentos (100%)                          │
│     • Document list, viewer, delete, PDF zoom                             │
│                                                                           │
│  ✅ Fase 5: Autenticación Biométrica (100%) ← COMPLETADO                  │
│     • Face ID, Touch ID, Fingerprint support                              │
│     • Auto-trigger, fallback, settings UI                                 │
│     • 3 components, 1 service, ~600 lines                                 │
│                                                                           │
│  🔜 Fase 6: Sistema de Recuperación (0%)                                  │
│     • Email recovery, token validation                                    │
│                                                                           │
│  🔜 Fase 7: Caché Offline (0%)                                            │
│     • Local storage, sync, conflict resolution                            │
│                                                                           │
│  🔜 Fase 8: Optimizaciones (0%)                                           │
│     • Lazy loading, pagination, search, analytics                         │
│                                                                           │
│  ────────────────────────────────────────────────────────                │
│                                                                           │
│  📊 Progress: 70% Complete (5.5 / 8 phases)                               │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
                              SUMMARY
═══════════════════════════════════════════════════════════════════════════════

✅ Sistema de autenticación biométrica completamente funcional
✅ Soporte para Face ID, Touch ID, Fingerprint, Iris
✅ Auto-trigger en 300ms para mejor UX
✅ Fallback automático a PIN si biometría falla
✅ Settings modal con toggle e info boxes
✅ Persistencia de preferencias en AsyncStorage
✅ No almacena datos biométricos (manejado por OS)
✅ Arquitectura limpia y modular
✅ Testing guide completo
✅ ~600 líneas de código
✅ 0 errores de compilación
✅ Solo 7 warnings (aceptables)

🎉 Fase 5 completada exitosamente
➡️ Lista para Fase 6: Sistema de Recuperación por Email
